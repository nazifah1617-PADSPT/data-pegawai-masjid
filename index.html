<!doctype html>
<html lang="ms">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Carian Maklumat Pegawai Masjid</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.min.js"></script>
  <style>
        @import url('https://fonts.googleapis.com/css2?family=Aptos:wght@400;500;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #334155;
        }
        
        .gradient-bg { 
            background: #1e293b;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .card-hover { 
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .card-hover:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }
        .search-input { 
            background: white;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease;
        }
        
        .search-input:focus { 
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-input::placeholder {
            color: #9ca3af;
        }
        .btn-primary {
            background: #3b82f6;
            border: none;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary {
            background: #64748b;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background: #475569;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn-success {
            background: #10b981;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .btn-success:hover {
            background: #059669;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn-purple {
            background: #8b5cf6;
            color: white !important;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .btn-purple:hover {
            background: #7c3aed;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .btn-danger {
            background: #ef4444;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .mosque-icon {
            color: #f59e0b;
        }
        
        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .table-row {
            transition: all 0.2s ease;
        }
        
        .table-row:hover {
            background: #f8fafc;
        }
        
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
        }
        

    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body><!-- Header -->
  <header id="mainHeader" class="gradient-bg text-white shadow-2xl relative z-10">
   <div class="container mx-auto px-6 py-12 relative z-10">
    <div class="flex items-center justify-between">
     <div class="flex items-center space-x-6">
      <div class="relative"><img src="https://i.postimg.cc/c4LmQcHK/logo-penangpng.png" alt="Logo Pulau Pinang" class="w-16 h-16 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
       <div class="text-5xl mosque-icon relative hidden">
        üïå 
        <div class="absolute -inset-2 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full opacity-20 blur-xl"></div>
       </div>
      </div>
      <div>
       <h1 class="text-3xl font-bold text-white mb-2">SISTEM CARIAN MAKLUMAT PEGAWAI MASJID</h1>
       <p class="text-slate-200 text-lg">Pengurusan Pegawai Imam, Bilal &amp; Siak</p>
      </div>
     </div>
     <div class="text-right p-4">
      <div class="text-sm text-slate-200 mb-1">
       üìÖ Tarikh
      </div>
      <p class="text-white font-semibold" id="currentDate"></p>
      <div class="text-sm text-slate-200 mb-1 mt-3">
       ‚è∞ Masa
      </div>
      <p class="text-white font-semibold" id="currentTime"></p>
     </div>
    </div>
   </div>
  </header><!-- Main Content -->
  <main id="mainContent" class="container mx-auto px-6 py-12 relative z-10"><!-- Global Search -->
   <div class="mb-10">
    <div class="card-hover rounded-3xl p-8 shadow-2xl border-2 border-white/30">
     <div class="text-center mb-6">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl mb-4 shadow-lg"><span class="text-3xl">üîç</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Carian Pegawai Masjid</h2>
      <p class="text-gray-600">Cari maklumat pegawai dengan mudah dan pantas</p>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Masjid</label> <select id="filterMasjid" class="search-input w-full px-4 py-3 border border-gray-300 rounded-lg"> <option value="">Semua Masjid</option> </select>
      </div>
      <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Jawatan</label> <select id="filterJawatan" class="search-input w-full px-4 py-3 border border-gray-300 rounded-lg"> <option value="">Semua Jawatan</option> <option value="pegawai-masjid">Pegawai Masjid</option> <option value="imam">Imam</option> <option value="bilal">Bilal</option> <option value="siak">Siak</option> </select>
      </div>
      <div class="md:col-span-1"><label class="block text-sm font-medium text-gray-700 mb-2">Carian (Nama atau No. K/P)</label> <input type="text" id="globalSearch" placeholder="üîç Cari nama atau no. k/p..." class="search-input w-full px-4 py-3 border border-gray-300 rounded-lg">
      </div>
     </div>
     <div class="flex gap-4"><button onclick="performGlobalSearch()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium"> üîç Cari </button> <button onclick="clearGlobalSearch()" class="btn-secondary text-white px-6 py-3 rounded-lg font-medium"> üóëÔ∏è Kosongkan </button>
     </div>
     <div id="globalSearchResults" class="mt-4 hidden">
      <div class="flex justify-between items-center mb-3">
       <h3 class="text-lg font-semibold text-gray-800">Keputusan Carian:</h3><button onclick="exportSearchResultsToPDF()" id="exportSearchBtn" class="btn-purple text-white px-4 py-2 rounded-lg font-medium text-sm hidden"> üñ®Ô∏è Cetak PDF Hasil Carian </button>
      </div>
      <div id="searchResultsContent" class="space-y-3"></div>
     </div>
    </div>
   </div><!-- Navigation Tabs -->
   <div class="mb-12">
    <div class="flex flex-wrap gap-3 bg-white p-3 rounded-lg shadow-sm border border-gray-200"><button onclick="showTab('imam')" id="tab-imam" class="tab-btn btn-primary text-white px-6 py-3 rounded-lg font-medium transition-all"> <span class="text-lg mr-2">üïå</span> Imam </button> <button onclick="showTab('bilal')" id="tab-bilal" class="tab-btn bg-gray-100 text-gray-700 px-6 py-3 rounded-lg font-medium transition-all hover:bg-gray-200"> <span class="text-lg mr-2">üì¢</span> Bilal </button> <button onclick="showTab('siak')" id="tab-siak" class="tab-btn bg-gray-100 text-gray-700 px-6 py-3 rounded-lg font-medium transition-all hover:bg-gray-200"> <span class="text-lg mr-2">üìã</span> Siak </button> <button onclick="showTab('laporan')" id="tab-laporan" class="tab-btn bg-gray-100 text-gray-700 px-6 py-3 rounded-lg font-medium transition-all hover:bg-gray-200"> <span class="text-lg mr-2">üìä</span> Laporan </button> <button onclick="goToHomePage()" class="tab-btn bg-gradient-to-r from-orange-500 to-red-500 text-white px-6 py-3 rounded-lg font-medium transition-all hover:from-orange-600 hover:to-red-600 hover:shadow-md"> <span class="text-lg mr-2">üè†</span> Laman Utama </button>
    </div>
   </div><!-- Imam Tab -->
   <div id="imam-tab" class="tab-content fade-in"><!-- Control Buttons -->
    <div class="mb-6 flex gap-4"><button onclick="toggleImamList()" id="toggleImamListBtn" class="btn-secondary text-white px-6 py-3 rounded-lg font-medium"> üìã Lihat Senarai Imam </button>
    </div>
    <div class="grid lg:grid-cols-1 gap-8"><!-- Senarai Imam -->
     <div id="imamListSection" class="lg:col-span-1 hidden">
      <div class="card-hover rounded-2xl p-6 shadow-xl">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center"><span class="text-2xl mr-3">üïå</span> Senarai Imam</h2>
        <div class="flex gap-2"><button onclick="exportToPDF('imam')" class="btn-purple text-white px-4 py-2 rounded-lg font-medium text-sm"> üñ®Ô∏è Cetak PDF </button>
        </div>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full">
         <thead>
          <tr class="bg-gray-50 border-b">
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Masjid</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Daerah</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Nama Imam</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">No. K/P</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Pekerjaan</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Alamat</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">No. Tel</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Umur</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Mula Khidmat</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Catatan</th>
          </tr>
         </thead>
         <tbody id="imamList">
          <tr>
           <td colspan="10" class="text-center py-8 text-gray-500" style="font-family: 'Aptos', sans-serif; text-transform: lowercase; letter-spacing: 0.3px;">
            <div class="text-4xl mb-2">
             üïå
            </div> tiada imam didaftarkan lagi</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Bilal Tab -->
   <div id="bilal-tab" class="tab-content hidden"><!-- Control Buttons -->
    <div class="mb-6 flex gap-4"><button onclick="toggleBilalList()" id="toggleBilalListBtn" class="btn-secondary text-white px-6 py-3 rounded-lg font-medium"> üìã Lihat Senarai Bilal </button>
    </div>
    <div class="grid lg:grid-cols-1 gap-8"><!-- Senarai Bilal -->
     <div id="bilalListSection" class="lg:col-span-1 hidden">
      <div class="card-hover rounded-2xl p-6 shadow-xl">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center"><span class="text-2xl mr-3">üì¢</span> Senarai Bilal</h2>
        <div class="flex gap-2"><button onclick="exportToPDF('bilal')" class="btn-purple text-white px-4 py-2 rounded-lg font-medium text-sm"> üñ®Ô∏è Cetak PDF </button>
        </div>
       </div>
       <div class="overflow-x-auto">
        <table class="w-full">
         <thead>
          <tr class="bg-gray-50 border-b">
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Masjid</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Daerah</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Nama Bilal</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">No. K/P</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Pekerjaan</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Alamat</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">No. Tel</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Umur</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Mula Khidmat</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Catatan</th>
          </tr>
         </thead>
         <tbody id="bilalList">
          <tr>
           <td colspan="10" class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">
             üì¢
            </div> Tiada bilal didaftarkan lagi</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Siak Tab -->
   <div id="siak-tab" class="tab-content hidden"><!-- Control Buttons -->
    <div class="mb-6 flex gap-4"><button onclick="toggleSiakList()" id="toggleSiakListBtn" class="btn-secondary text-white px-6 py-3 rounded-xl font-medium"> üìã Lihat Senarai Siak </button>
    </div>
    <div class="grid lg:grid-cols-1 gap-8"><!-- Senarai Siak -->
     <div id="siakListSection" class="lg:col-span-1 hidden">
      <div class="card-hover rounded-2xl p-6 shadow-xl">
       <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center"><span class="text-2xl mr-3">üìã</span> Senarai Siak</h2>
        <div class="flex gap-2"><button onclick="exportToPDF('siak')" class="btn-purple text-white px-4 py-2 rounded-lg font-medium text-sm"> üñ®Ô∏è Cetak PDF </button>
        </div>
       </div>
       <div class="mb-4"><input type="text" id="searchSiak" placeholder="üîç Cari siak..." class="search-input w-full px-4 py-3 border border-gray-300 rounded-xl">
       </div>
       <div class="overflow-x-auto">
        <table class="w-full">
         <thead>
          <tr class="bg-gray-50 border-b">
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Masjid</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Daerah</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Nama Siak</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">No. K/P</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Pekerjaan</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Alamat</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">No. Tel</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Umur</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Mula Khidmat</th>
           <th class="text-left py-3 px-4 font-semibold text-gray-700">Catatan</th>
          </tr>
         </thead>
         <tbody id="siakList">
          <tr>
           <td colspan="10" class="text-center py-8 text-gray-500">
            <div class="text-4xl mb-2">
             üìã
            </div> Tiada siak didaftarkan lagi</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Laporan Tab -->
   <div id="laporan-tab" class="tab-content hidden">
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12"><!-- Statistik Cards -->
     <div class="card-hover rounded-lg p-6 shadow-sm text-center border border-gray-200 bg-blue-50">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-500 rounded-lg mb-4"><span class="text-2xl text-white">üïå</span>
      </div>
      <h3 class="text-lg font-bold text-gray-800 mb-2">Jumlah Imam</h3>
      <p class="text-3xl font-bold text-blue-600" id="totalImam">0</p>
      <div class="mt-3 text-sm text-gray-600">
       Pegawai Imam Terdaftar
      </div>
     </div>
     <div class="card-hover rounded-lg p-6 shadow-sm text-center border border-gray-200 bg-green-50">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-green-500 rounded-lg mb-4"><span class="text-2xl text-white">üì¢</span>
      </div>
      <h3 class="text-lg font-bold text-gray-800 mb-2">Jumlah Bilal</h3>
      <p class="text-3xl font-bold text-green-600" id="totalBilal">0</p>
      <div class="mt-3 text-sm text-gray-600">
       Pegawai Bilal Terdaftar
      </div>
     </div>
     <div class="card-hover rounded-lg p-6 shadow-sm text-center border border-gray-200 bg-purple-50">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-500 rounded-lg mb-4"><span class="text-2xl text-white">üìã</span>
      </div>
      <h3 class="text-lg font-bold text-gray-800 mb-2">Jumlah Siak</h3>
      <p class="text-3xl font-bold text-purple-600" id="totalSiak">0</p>
      <div class="mt-3 text-sm text-gray-600">
       Pegawai Siak Terdaftar
      </div>
     </div>
    </div><!-- Laporan Terperinci -->
    <div class="card-hover rounded-lg p-6 shadow-sm border border-gray-200">
     <div class="text-center mb-6">
      <div class="inline-flex items-center justify-center w-12 h-12 bg-orange-500 rounded-lg mb-4"><span class="text-xl text-white">üìà</span>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Laporan Terperinci</h2>
      <p class="text-gray-600">Muat turun laporan lengkap dalam format PDF</p>
     </div>
     <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"><button onclick="generateReport('imam')" class="btn-primary text-white p-6 rounded-lg text-center group hover:shadow-md transition-all">
       <div class="inline-flex items-center justify-center w-12 h-12 bg-white/20 rounded-lg mb-3"><span class="text-2xl">üïå</span>
       </div><h3 class="font-bold text-lg mb-2">Cetak Laporan Imam</h3><p class="text-sm opacity-90">Senarai lengkap imam masjid dengan maklumat terperinci</p></button> <button onclick="generateReport('bilal')" class="btn-success text-white p-6 rounded-lg text-center group hover:shadow-md transition-all">
       <div class="inline-flex items-center justify-center w-12 h-12 bg-white/20 rounded-lg mb-3"><span class="text-2xl">üì¢</span>
       </div><h3 class="font-bold text-lg mb-2">Cetak Laporan Bilal</h3><p class="text-sm opacity-90">Senarai lengkap bilal masjid dengan maklumat terperinci</p></button> <button onclick="generateReport('siak')" class="btn-purple text-white p-6 rounded-lg text-center group hover:shadow-md transition-all">
       <div class="inline-flex items-center justify-center w-12 h-12 bg-white/20 rounded-lg mb-3"><span class="text-2xl">üìã</span>
       </div><h3 class="font-bold text-lg mb-2">Cetak Laporan Siak</h3><p class="text-sm opacity-90">Senarai lengkap siak masjid dengan maklumat terperinci</p></button>
     </div>
    </div>
   </div>
  </main><!-- Modal untuk PDF Preview -->
  <div id="pdfPreviewModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
   <div class="bg-white rounded-lg p-6 max-w-5xl w-full shadow-lg max-h-[90vh] overflow-hidden border border-gray-200">
    <div class="flex justify-between items-center mb-6">
     <div class="flex items-center space-x-3">
      <div class="inline-flex items-center justify-center w-10 h-10 bg-blue-500 rounded-lg"><span class="text-lg text-white">üìÑ</span>
      </div>
      <div>
       <h3 class="text-xl font-bold text-gray-800" id="pdfPreviewTitle">Pratonton Laporan</h3>
       <p class="text-gray-600">Semak laporan sebelum muat turun</p>
      </div>
     </div><button onclick="closePdfPreview()" class="text-gray-400 hover:text-gray-600 text-2xl font-light transition-colors hover:bg-gray-100 rounded w-8 h-8 flex items-center justify-center">√ó</button>
    </div>
    <div id="pdfPreviewContent" class="overflow-y-auto max-h-[60vh] mb-6 border border-gray-200 rounded-lg p-4 bg-gray-50"><!-- Preview content will be inserted here -->
    </div>
    <div class="flex gap-4"><button onclick="closePdfPreview()" class="flex-1 btn-secondary text-white py-3 px-6 rounded-lg font-medium"> ‚ùå Tutup </button> <button onclick="confirmDirectPrint()" class="flex-1 btn-primary text-white py-3 px-6 rounded-lg font-medium"> üñ®Ô∏è Terus Cetak </button>
    </div>
   </div>
  </div>
  <script>
        // Data storage
        let imamData = [];
        let bilalData = [];
        let siakData = [];

        // Google Sheets CSV URLs
        const IMAM_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTMdVbauPNjDdm5PjpJ9757hQAjohDd0rtXxHUfzFOZwbVovFSD6P8x41wsjfzxjw/pub?gid=1151842269&single=true&output=csv';
        const BILAL_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9-yKvr5cPnPV6iTD0RSRph69RGm1J7rwR6dwVaKHR0mG6Eb3wZMXeJu9O4-mgIg/pub?output=csv';
        const SIAK_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQDy3scnQAEvhEXgi6w_zWw7AkIyh7du4EHnXJjn4BJGhHHBGY-wnR_6Ow70oDxjw/pub?gid=654609828&single=true&output=csv';

        // Function to calculate age from Malaysian IC number
        function calculateAgeFromIC(nokp) {
            if (!nokp || nokp.length < 6) return '-';
            
            try {
                const yearDigits = nokp.substring(0, 2);
                const month = nokp.substring(2, 4);
                const day = nokp.substring(4, 6);
                
                const year = parseInt(yearDigits) > 30 ? `19${yearDigits}` : `20${yearDigits}`;
                
                const birthDate = new Date(`${year}-${month}-${day}`);
                const today = new Date();
                
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                return age > 0 && age < 150 ? age : '-';
            } catch (error) {
                return '-';
            }
        }

        // Function to load Imam data from Google Sheets
        async function loadImamDataFromSheet() {
            console.log('üîÑ Memuat data imam dari Google Sheets...');
            
            try {
                const response = await fetch(IMAM_SHEET_URL, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'text/csv,text/plain,*/*'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('üìÑ CSV data received:', csvText.substring(0, 200) + '...');
                
                const lines = csvText.split('\n').filter(line => line.trim());
                console.log(`üìä Found ${lines.length} lines in CSV`);
                
                imamData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const values = parseCSVLine(line);
                        console.log(`Row ${i}:`, values);
                        
                        if (values.length >= 8) {
                            const nokp = values[4] || '';
                            const calculatedAge = calculateAgeFromIC(nokp);
                            
                            const imam = {
                                id: Date.now() + i,
                                bil: values[0] || i,
                                masjid: values[1] || '',
                                daerah: values[2] || '',
                                nama: values[3] || '',
                                nokp: nokp,
                                pekerjaan: values[5] || '',
                                alamat: values[6] || '',
                                telefon: values[7] || '',
                                umur: values[8] || calculatedAge,
                                mulaKhidmat: values[9] || new Date().toISOString().split('T')[0],
                                catatan: values[10] || ''
                            };
                            imamData.push(imam);
                        }
                    }
                }
                
                console.log(`‚úÖ Berjaya memuat ${imamData.length} data imam`);
                displayImam();
                updateStatistics();
                updateFilterDropdowns();
                
            } catch (error) {
                console.error('‚ùå Ralat memuat data imam:', error);
                showNotification(`‚ö†Ô∏è Sambungan Google Sheets gagal: ${error.message}. Sila cuba lagi.`, 'warning');
            }
        }

        // Function to load Bilal data from Google Sheets
        async function loadBilalDataFromSheet() {
            console.log('üîÑ Memuat data bilal dari Google Sheets...');
            
            try {
                const response = await fetch(BILAL_SHEET_URL, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'text/csv,text/plain,*/*'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('üìÑ CSV data received:', csvText.substring(0, 200) + '...');
                
                const lines = csvText.split('\n').filter(line => line.trim());
                console.log(`üìä Found ${lines.length} lines in CSV`);
                
                bilalData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const values = parseCSVLine(line);
                        console.log(`Row ${i}:`, values);
                        
                        if (values.length >= 8) {
                            const nokp = values[4] || '';
                            const calculatedAge = calculateAgeFromIC(nokp);
                            
                            const bilal = {
                                id: Date.now() + i + 1000,
                                bil: values[0] || i,
                                masjid: values[1] || '',
                                daerah: values[2] || '',
                                nama: values[3] || '',
                                nokp: nokp,
                                pekerjaan: values[5] || '',
                                alamat: values[6] || '',
                                telefon: values[7] || '',
                                umur: values[8] || calculatedAge,
                                mulaKhidmat: values[9] || new Date().toISOString().split('T')[0],
                                catatan: values[10] || ''
                            };
                            bilalData.push(bilal);
                        }
                    }
                }
                
                console.log(`‚úÖ Berjaya memuat ${bilalData.length} data bilal`);
                displayBilal();
                updateStatistics();
                updateFilterDropdowns();
                
            } catch (error) {
                console.error('‚ùå Ralat memuat data bilal:', error);
                showNotification(`‚ö†Ô∏è Sambungan Google Sheets gagal: ${error.message}. Sila cuba lagi.`, 'warning');
            }
        }

        // Function to load Siak data from Google Sheets
        async function loadSiakDataFromSheet() {
            console.log('üîÑ Memuat data siak dari Google Sheets...');
            
            try {
                const response = await fetch(SIAK_SHEET_URL, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'text/csv,text/plain,*/*'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('üìÑ CSV data received:', csvText.substring(0, 200) + '...');
                
                const lines = csvText.split('\n').filter(line => line.trim());
                console.log(`üìä Found ${lines.length} lines in CSV`);
                
                siakData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const values = parseCSVLine(line);
                        console.log(`Row ${i}:`, values);
                        
                        if (values.length >= 8) {
                            const nokp = values[4] || '';
                            const calculatedAge = calculateAgeFromIC(nokp);
                            
                            const siak = {
                                id: Date.now() + i + 2000,
                                bil: values[0] || i,
                                masjid: values[1] || '',
                                daerah: values[2] || '',
                                nama: values[3] || '',
                                nokp: nokp,
                                pekerjaan: values[5] || '',
                                alamat: values[6] || '',
                                telefon: values[7] || '',
                                umur: calculatedAge,
                                mulaKhidmat: values[9] || new Date().toISOString().split('T')[0],
                                catatan: values[10] || ''
                            };
                            siakData.push(siak);
                        }
                    }
                }
                
                console.log(`‚úÖ Berjaya memuat ${siakData.length} data siak`);
                displaySiak();
                updateStatistics();
                updateFilterDropdowns();
                
            } catch (error) {
                console.error('‚ùå Ralat memuat data siak:', error);
                showNotification(`‚ö†Ô∏è Sambungan Google Sheets gagal: ${error.message}. Sila cuba lagi.`, 'warning');
            }
        }

        // Function to parse CSV line properly
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/"/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim().replace(/"/g, ''));
            return result;
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ms-MY', options);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ms-MY');
        }

        // Tab functionality
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            document.getElementById('tab-' + tabName).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('tab-' + tabName).classList.add('btn-primary', 'text-white');
        }
        
        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 translate-x-full`;
            
            switch(type) {
                case 'success':
                    notification.classList.add('bg-green-500');
                    break;
                case 'warning':
                    notification.classList.add('bg-yellow-500');
                    break;
                case 'error':
                    notification.classList.add('bg-red-500');
                    break;
                default:
                    notification.classList.add('bg-blue-500');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }



        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize main system directly
            showTab('laporan');
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Load data automatically in background
            loadImamDataFromSheet();
            loadBilalDataFromSheet();
            loadSiakDataFromSheet();
            
            updateStatistics();
            updateFilterDropdowns();
            
            // Search functionality
            const searchSiak = document.getElementById('searchSiak');
            const globalSearch = document.getElementById('globalSearch');
            
            if (searchSiak) searchSiak.addEventListener('input', () => searchTable('siak'));
            
            if (globalSearch) {
                globalSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performGlobalSearch();
                    }
                });
            }
        });

        // Display imam (without BIL column)
        function displayImam() {
            const tbody = document.getElementById('imamList');
            
            if (imamData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üïå</div>
                            Tiada imam didaftarkan lagi
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = imamData.map((imam, index) => `
                <tr class="table-row border-b hover:bg-blue-50 transition-colors">
                    <td class="py-3 px-4">${imam.masjid}</td>
                    <td class="py-3 px-4">${imam.daerah}</td>
                    <td class="py-3 px-4 font-medium">${imam.nama}</td>
                    <td class="py-3 px-4">${imam.nokp}</td>
                    <td class="py-3 px-4">${imam.pekerjaan}</td>
                    <td class="py-3 px-4">${imam.alamat}</td>
                    <td class="py-3 px-4">${imam.telefon}</td>
                    <td class="py-3 px-4">${imam.umur}</td>
                    <td class="py-3 px-4">${new Date(imam.mulaKhidmat).toLocaleDateString('ms-MY')}</td>
                    <td class="py-3 px-4">${imam.catatan || '-'}</td>
                </tr>
            `).join('');
        }

        // Display bilal (without BIL column)
        function displayBilal() {
            const tbody = document.getElementById('bilalList');
            
            if (bilalData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üì¢</div>
                            Tiada bilal didaftarkan lagi
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = bilalData.map((bilal, index) => `
                <tr class="table-row border-b hover:bg-blue-50 transition-colors">
                    <td class="py-3 px-4">${bilal.masjid}</td>
                    <td class="py-3 px-4">${bilal.daerah}</td>
                    <td class="py-3 px-4 font-medium">${bilal.nama}</td>
                    <td class="py-3 px-4">${bilal.nokp}</td>
                    <td class="py-3 px-4">${bilal.pekerjaan}</td>
                    <td class="py-3 px-4">${bilal.alamat}</td>
                    <td class="py-3 px-4">${bilal.telefon}</td>
                    <td class="py-3 px-4">${bilal.umur}</td>
                    <td class="py-3 px-4">${new Date(bilal.mulaKhidmat).toLocaleDateString('ms-MY')}</td>
                    <td class="py-3 px-4">${bilal.catatan || '-'}</td>
                </tr>
            `).join('');
        }

        // Display siak (without BIL column)
        function displaySiak() {
            const tbody = document.getElementById('siakList');
            
            if (siakData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üìã</div>
                            Tiada siak didaftarkan lagi
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = siakData.map((siak, index) => `
                <tr class="table-row border-b hover:bg-blue-50 transition-colors">
                    <td class="py-3 px-4">${siak.masjid}</td>
                    <td class="py-3 px-4">${siak.daerah}</td>
                    <td class="py-3 px-4 font-medium">${siak.nama}</td>
                    <td class="py-3 px-4">${siak.nokp}</td>
                    <td class="py-3 px-4">${siak.pekerjaan}</td>
                    <td class="py-3 px-4">${siak.alamat}</td>
                    <td class="py-3 px-4">${siak.telefon}</td>
                    <td class="py-3 px-4">${siak.umur}</td>
                    <td class="py-3 px-4">${new Date(siak.mulaKhidmat).toLocaleDateString('ms-MY')}</td>
                    <td class="py-3 px-4">${siak.catatan || '-'}</td>
                </tr>
            `).join('');
        }

        // Update statistics
        function updateStatistics() {
            document.getElementById('totalImam').textContent = imamData.length;
            document.getElementById('totalBilal').textContent = bilalData.length;
            document.getElementById('totalSiak').textContent = siakData.length;
        }

        // Update filter dropdowns
        function updateFilterDropdowns() {
            const allData = [...imamData, ...bilalData, ...siakData];
            
            // Update Masjid filter
            const masjidSet = new Set();
            allData.forEach(item => {
                if (item.masjid) masjidSet.add(item.masjid);
            });
            
            const filterMasjid = document.getElementById('filterMasjid');
            if (filterMasjid) {
                filterMasjid.innerHTML = '<option value="">Semua Masjid</option>';
                Array.from(masjidSet).sort().forEach(masjid => {
                    filterMasjid.innerHTML += `<option value="${masjid}">${masjid}</option>`;
                });
            }
        }

        // Search functionality
        function searchTable(type) {
            const searchTerm = document.getElementById(`search${type.charAt(0).toUpperCase() + type.slice(1)}`).value.toLowerCase();
            const rows = document.querySelectorAll(`#${type}List tr`);
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // PDF Preview and Export functionality
        let currentPdfData = null;
        let currentPdfType = '';

        function exportToPDF(type) {
            currentPdfType = type;
            generatePDFDirectly(type);
        }

        function generatePDFDirectly(type) {
            let tableData = [];
            let headers = [];
            let title = 'Data Pegawai Masjid';
            let kategori = '';
            
            if (type === 'imam') {
                kategori = 'IMAM';
                headers = ['Bil', 'Nama Imam', 'No. K/P', 'Pekerjaan', 'Alamat', 'No. Tel', 'Umur', 'Mula Khidmat'];
                tableData = imamData.map((imam, index) => [
                    index + 1,
                    imam.nama,
                    imam.nokp,
                    imam.pekerjaan,
                    imam.alamat,
                    imam.telefon,
                    imam.umur,
                    new Date(imam.mulaKhidmat).toLocaleDateString('ms-MY')
                ]);
            } else if (type === 'bilal') {
                kategori = 'BILAL';
                headers = ['Bil', 'Nama Bilal', 'No. K/P', 'Pekerjaan', 'Alamat', 'No. Tel', 'Umur', 'Mula Khidmat'];
                tableData = bilalData.map((bilal, index) => [
                    index + 1,
                    bilal.nama,
                    bilal.nokp,
                    bilal.pekerjaan,
                    bilal.alamat,
                    bilal.telefon,
                    bilal.umur,
                    new Date(bilal.mulaKhidmat).toLocaleDateString('ms-MY')
                ]);
            } else {
                kategori = 'SIAK';
                headers = ['Bil', 'Nama Siak', 'No. K/P', 'Pekerjaan', 'Alamat', 'No. Tel', 'Umur', 'Mula Khidmat'];
                tableData = siakData.map((siak, index) => [
                    index + 1,
                    siak.nama,
                    siak.nokp,
                    siak.pekerjaan,
                    siak.alamat,
                    siak.telefon,
                    siak.umur,
                    new Date(siak.mulaKhidmat).toLocaleDateString('ms-MY')
                ]);
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // Add logo
            const logoUrl = 'https://i.postimg.cc/c4LmQcHK/logo-penangpng.png';
            try {
                doc.addImage(logoUrl, 'PNG', 20, 10, 30, 30);
            } catch (error) {
                console.log('Logo tidak dapat dimuatkan');
            }
            
            // Header for regular reports
            doc.setFontSize(18);
            doc.text(title, 148, 25, { align: 'center' });
            
            doc.setFontSize(16);
            doc.text(kategori, 148, 40, { align: 'center' });
            
            // Date and count info
            doc.setFontSize(10);
            doc.text(`Tarikh: ${new Date().toLocaleDateString('ms-MY')}`, 20, 55);
            doc.text(`Jumlah Rekod: ${tableData.length}`, 20, 65);
            
            // Table
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 75,
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [30, 41, 59],
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold'
                }
            });
            
            doc.save(`data-pegawai-${type}-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification(`‚úÖ Data Pegawai ${kategori} berjaya dicetak!`, 'success');
        }

        function closePdfPreview() {
            document.getElementById('pdfPreviewModal').classList.add('hidden');
            document.getElementById('pdfPreviewModal').classList.remove('flex');
            currentPdfData = null;
            currentPdfType = '';
        }

        // Generate report
        function generateReport(type) {
            exportToPDF(type);
        }

        // Global search functionality
        let currentSearchResults = [];
        let currentSearchTerm = '';

        function performGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase().trim();
            const filterMasjid = document.getElementById('filterMasjid').value;
            const filterJawatan = document.getElementById('filterJawatan').value;
            
            const results = [];
            
            // Search in Imam data
            if (!filterJawatan || filterJawatan === 'imam' || filterJawatan === 'pegawai-masjid') {
                imamData.forEach((imam, index) => {
                    const matchesSearch = !searchTerm || imam.nama.toLowerCase().includes(searchTerm) || imam.nokp.includes(searchTerm);
                    const matchesMasjid = !filterMasjid || imam.masjid === filterMasjid;
                    
                    if (matchesSearch && matchesMasjid) {
                        results.push({
                            type: 'Imam',
                            data: imam,
                            index: index,
                            icon: 'üïå'
                        });
                    }
                });
            }
            
            // Search in Bilal data
            if (!filterJawatan || filterJawatan === 'bilal' || filterJawatan === 'pegawai-masjid') {
                bilalData.forEach((bilal, index) => {
                    const matchesSearch = !searchTerm || bilal.nama.toLowerCase().includes(searchTerm) || bilal.nokp.includes(searchTerm);
                    const matchesMasjid = !filterMasjid || bilal.masjid === filterMasjid;
                    
                    if (matchesSearch && matchesMasjid) {
                        results.push({
                            type: 'Bilal',
                            data: bilal,
                            index: index,
                            icon: 'üì¢'
                        });
                    }
                });
            }
            
            // Search in Siak data
            if (!filterJawatan || filterJawatan === 'siak' || filterJawatan === 'pegawai-masjid') {
                siakData.forEach((siak, index) => {
                    const matchesSearch = !searchTerm || siak.nama.toLowerCase().includes(searchTerm) || siak.nokp.includes(searchTerm);
                    const matchesMasjid = !filterMasjid || siak.masjid === filterMasjid;
                    
                    if (matchesSearch && matchesMasjid) {
                        results.push({
                            type: 'Siak',
                            data: siak,
                            index: index,
                            icon: 'üìã'
                        });
                    }
                });
            }
            
            displayGlobalSearchResults(results, searchTerm || 'filter');
        }

        function displayGlobalSearchResults(results, searchTerm) {
            const resultsContainer = document.getElementById('globalSearchResults');
            const resultsContent = document.getElementById('searchResultsContent');
            const exportBtn = document.getElementById('exportSearchBtn');
            
            currentSearchResults = results;
            currentSearchTerm = searchTerm;
            
            if (results.length === 0) {
                resultsContent.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üîç</div>
                        <p>Tiada keputusan ditemui untuk carian ini</p>
                        <p class="text-sm mt-2">Cuba ubah kriteria carian anda</p>
                    </div>
                `;
                exportBtn.classList.add('hidden');
            } else {
                resultsContent.innerHTML = results.map(result => {
                    // Determine the correct tab to navigate to
                    let tabName = '';
                    if (['Imam'].includes(result.type)) {
                        tabName = 'imam';
                    } else if (['Bilal'].includes(result.type)) {
                        tabName = 'bilal';
                    } else if (['Siak'].includes(result.type)) {
                        tabName = 'siak';
                    }
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center mb-2">
                                        <span class="text-lg mr-2">${result.icon}</span>
                                        <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded">${result.type}</span>
                                    </div>
                                    <h4 class="text-lg font-semibold text-gray-800 mb-1">${result.data.nama}</h4>
                                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                                        <div><strong>Masjid:</strong> ${result.data.masjid}</div>
                                        ${result.data.daerah ? `<div><strong>Daerah:</strong> ${result.data.daerah}</div>` : ''}
                                        <div><strong>No. K/P:</strong> ${result.data.nokp}</div>
                                        <div><strong>Pekerjaan:</strong> ${result.data.pekerjaan}</div>
                                        <div class="col-span-2"><strong>Alamat:</strong> ${result.data.alamat}</div>
                                        <div><strong>No. Tel:</strong> ${result.data.telefon}</div>
                                        <div><strong>Umur:</strong> ${result.data.umur || '-'}</div>
                                        ${result.data.mulaKhidmat ? `<div><strong>Mula Khidmat:</strong> ${new Date(result.data.mulaKhidmat).toLocaleDateString('ms-MY')}</div>` : ''}
                                        ${result.data.catatan ? `<div class="col-span-2"><strong>Catatan:</strong> ${result.data.catatan || '-'}</div>` : ''}
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2 ml-4">
                                    <button onclick="goToTab('${tabName}')" class="text-green-600 hover:text-green-800 text-sm px-3 py-1 border border-green-300 rounded hover:bg-green-50 transition-colors">
                                        üëÅÔ∏è Lihat
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                exportBtn.classList.remove('hidden');
            }
            
            resultsContainer.classList.remove('hidden');
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Export search results to PDF with preview
        function exportSearchResultsToPDF() {
            if (currentSearchResults.length === 0) {
                showNotification('Tiada hasil carian untuk dicetak!', 'warning');
                return;
            }

            // Show preview modal
            showSearchResultsPDFPreview();
        }

        function showSearchResultsPDFPreview() {
            const modal = document.getElementById('pdfPreviewModal');
            const title = document.getElementById('pdfPreviewTitle');
            const content = document.getElementById('pdfPreviewContent');
            
            // Determine category based on search results
            const categories = [...new Set(currentSearchResults.map(result => result.type.toUpperCase()))];
            const kategori = categories.length === 1 ? categories[0] : categories.join(', ');
            
            title.textContent = `Pratonton Laporan Hasil Carian - ${kategori}`;
            
            // Generate preview content
            const previewHTML = `
                <div class="bg-white p-6 border border-gray-300 rounded-lg">
                    <div class="text-center mb-6">
                        <div class="flex items-center justify-center mb-4">
                            <img src="https://i.postimg.cc/c4LmQcHK/logo-penangpng.png" alt="Logo" class="w-12 h-12 mr-4" onerror="this.style.display='none';">
                            <div>
                                <h1 class="text-xl font-bold text-gray-800">SISTEM CARIAN MAKLUMAT PEGAWAI MASJID</h1>
                                <h2 class="text-lg font-semibold text-blue-600">${kategori}</h2>
                            </div>
                        </div>
                        <div class="text-sm text-gray-600 mb-4">
                            <p><strong>Tarikh:</strong> ${new Date().toLocaleDateString('ms-MY')}</p>
                            <p><strong>Jumlah Rekod:</strong> ${currentSearchResults.length}</p>
                            <p><strong>Kriteria Carian:</strong> ${currentSearchTerm}</p>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Bil</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Jawatan</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Nama</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">No. K/P</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Pekerjaan</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Masjid</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">No. Tel</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Umur</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentSearchResults.map((result, index) => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="border border-gray-300 px-2 py-2">${index + 1}</td>
                                        <td class="border border-gray-300 px-2 py-2">${result.type}</td>
                                        <td class="border border-gray-300 px-2 py-2 font-medium">${result.data.nama}</td>
                                        <td class="border border-gray-300 px-2 py-2">${result.data.nokp}</td>
                                        <td class="border border-gray-300 px-2 py-2">${result.data.pekerjaan}</td>
                                        <td class="border border-gray-300 px-2 py-2">${result.data.masjid}</td>
                                        <td class="border border-gray-300 px-2 py-2">${result.data.telefon}</td>
                                        <td class="border border-gray-300 px-2 py-2">${result.data.umur || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-6 text-center text-xs text-gray-500">
                        <p>¬© 2024 Sistem Pengurusan Pegawai Masjid - Laporan Hasil Carian</p>
                        <p>Dokumen ini dijana secara automatik pada ${new Date().toLocaleString('ms-MY')}</p>
                    </div>
                </div>
            `;
            
            content.innerHTML = previewHTML;
            
            // Store current data for PDF generation
            currentPdfData = {
                type: 'search-results',
                title: 'Data Pegawai Masjid',
                kategori: kategori,
                headers: ['Bil', 'Jawatan', 'Nama', 'No. K/P', 'Pekerjaan', 'Masjid', 'No. Tel', 'Umur'],
                data: currentSearchResults.map((result, index) => [
                    index + 1,
                    result.type,
                    result.data.nama,
                    result.data.nokp,
                    result.data.pekerjaan,
                    result.data.masjid,
                    result.data.telefon,
                    result.data.umur || '-'
                ])
            };
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function confirmPdfDownload() {
            if (!currentPdfData) {
                showNotification('Tiada data untuk dicetak!', 'warning');
                return;
            }

            if (currentPdfData.type === 'search-results') {
                generateSearchResultsPDF();
            } else {
                generatePDFDirectly(currentPdfType);
            }
            
            closePdfPreview();
        }

        function confirmDirectPrint() {
            if (!currentPdfData) {
                showNotification('Tiada data untuk dicetak!', 'warning');
                return;
            }

            if (currentPdfData.type === 'search-results') {
                generateAndPrintSearchResults();
            } else {
                generateAndPrintPDF(currentPdfType);
            }
            
            closePdfPreview();
        }

        function generateAndPrintPDF(type) {
            let tableData = [];
            let headers = [];
            let title = 'Data Pegawai Masjid';
            let kategori = '';
            
            if (type === 'imam') {
                kategori = 'IMAM';
                headers = ['Bil', 'Nama Imam', 'No. K/P', 'Pekerjaan', 'Alamat', 'No. Tel', 'Umur', 'Mula Khidmat'];
                tableData = imamData.map((imam, index) => [
                    index + 1,
                    imam.nama,
                    imam.nokp,
                    imam.pekerjaan,
                    imam.alamat,
                    imam.telefon,
                    imam.umur,
                    new Date(imam.mulaKhidmat).toLocaleDateString('ms-MY')
                ]);
            } else if (type === 'bilal') {
                kategori = 'BILAL';
                headers = ['Bil', 'Nama Bilal', 'No. K/P', 'Pekerjaan', 'Alamat', 'No. Tel', 'Umur', 'Mula Khidmat'];
                tableData = bilalData.map((bilal, index) => [
                    index + 1,
                    bilal.nama,
                    bilal.nokp,
                    bilal.pekerjaan,
                    bilal.alamat,
                    bilal.telefon,
                    bilal.umur,
                    new Date(bilal.mulaKhidmat).toLocaleDateString('ms-MY')
                ]);
            } else {
                kategori = 'SIAK';
                headers = ['Bil', 'Nama Siak', 'No. K/P', 'Pekerjaan', 'Alamat', 'No. Tel', 'Umur', 'Mula Khidmat'];
                tableData = siakData.map((siak, index) => [
                    index + 1,
                    siak.nama,
                    siak.nokp,
                    siak.pekerjaan,
                    siak.alamat,
                    siak.telefon,
                    siak.umur,
                    new Date(siak.mulaKhidmat).toLocaleDateString('ms-MY')
                ]);
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // Add logo
            const logoUrl = 'https://i.postimg.cc/c4LmQcHK/logo-penangpng.png';
            try {
                doc.addImage(logoUrl, 'PNG', 20, 10, 30, 30);
            } catch (error) {
                console.log('Logo tidak dapat dimuatkan');
            }
            
            // Header for regular reports
            doc.setFontSize(18);
            doc.text(title, 148, 25, { align: 'center' });
            
            doc.setFontSize(16);
            doc.text(kategori, 148, 40, { align: 'center' });
            
            // Date and count info
            doc.setFontSize(10);
            doc.text(`Tarikh: ${new Date().toLocaleDateString('ms-MY')}`, 20, 55);
            doc.text(`Jumlah Rekod: ${tableData.length}`, 20, 65);
            
            // Table
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 75,
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [30, 41, 59],
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold'
                }
            });
            
            // Open print dialog directly
            doc.autoPrint();
            window.open(doc.output('bloburl'), '_blank');
            showNotification(`‚úÖ Data Pegawai ${kategori} siap untuk dicetak!`, 'success');
        }

        function generateAndPrintSearchResults() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // Add logo
            const logoUrl = 'https://i.postimg.cc/c4LmQcHK/logo-penangpng.png';
            try {
                doc.addImage(logoUrl, 'PNG', 20, 10, 30, 30);
            } catch (error) {
                console.log('Logo tidak dapat dimuatkan');
            }
            
            // Header for search results
            doc.setFontSize(18);
            doc.text(currentPdfData.title, 148, 25, { align: 'center' });
            
            doc.setFontSize(16);
            doc.text(currentPdfData.kategori, 148, 40, { align: 'center' });
            
            // Date and count info
            doc.setFontSize(10);
            doc.text(`Tarikh: ${new Date().toLocaleDateString('ms-MY')}`, 20, 55);
            doc.text(`Jumlah Rekod: ${currentPdfData.data.length}`, 20, 65);
            doc.text(`Kriteria Carian: ${currentSearchTerm}`, 20, 75);
            
            doc.autoTable({
                head: [currentPdfData.headers],
                body: currentPdfData.data,
                startY: 85,
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [30, 41, 59],
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold'
                }
            });
            
            // Open print dialog directly
            doc.autoPrint();
            window.open(doc.output('bloburl'), '_blank');
            showNotification('‚úÖ Data Pegawai Masjid hasil carian siap untuk dicetak!', 'success');
        }

        function generateSearchResultsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // Add logo
            const logoUrl = 'https://i.postimg.cc/c4LmQcHK/logo-penangpng.png';
            try {
                doc.addImage(logoUrl, 'PNG', 20, 10, 30, 30);
            } catch (error) {
                console.log('Logo tidak dapat dimuatkan');
            }
            
            // Header for search results
            doc.setFontSize(18);
            doc.text(currentPdfData.title, 148, 25, { align: 'center' });
            
            doc.setFontSize(16);
            doc.text(currentPdfData.kategori, 148, 40, { align: 'center' });
            
            // Date and count info
            doc.setFontSize(10);
            doc.text(`Tarikh: ${new Date().toLocaleDateString('ms-MY')}`, 20, 55);
            doc.text(`Jumlah Rekod: ${currentPdfData.data.length}`, 20, 65);
            doc.text(`Kriteria Carian: ${currentSearchTerm}`, 20, 75);
            
            doc.autoTable({
                head: [currentPdfData.headers],
                body: currentPdfData.data,
                startY: 85,
                styles: {
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [30, 41, 59],
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold'
                }
            });
            
            doc.save(`data-pegawai-hasil-carian-${currentSearchTerm.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('‚úÖ Data Pegawai Masjid hasil carian berjaya dicetak!', 'success');
        }
        
        function clearGlobalSearch() {
            document.getElementById('globalSearch').value = '';
            document.getElementById('filterMasjid').value = '';
            document.getElementById('filterJawatan').value = '';
            document.getElementById('globalSearchResults').classList.add('hidden');
            document.getElementById('exportSearchBtn').classList.add('hidden');
            currentSearchResults = [];
            currentSearchTerm = '';
        }
        
        function goToTab(type) {
            showTab(type);
            document.getElementById(type + '-tab').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function goToHomePage() {
            window.location.href = 'https://padspt.vercel.app/';
        }

        // Toggle functions for forms and lists        
        function toggleImamList() {
            const listSection = document.getElementById('imamListSection');
            const listBtn = document.getElementById('toggleImamListBtn');
            
            if (listSection.classList.contains('hidden')) {
                listSection.classList.remove('hidden');
                listBtn.classList.remove('btn-secondary');
                listBtn.classList.add('btn-primary');
                listBtn.innerHTML = '‚ùå Tutup Senarai';
            } else {
                listSection.classList.add('hidden');
                listBtn.classList.remove('btn-primary');
                listBtn.classList.add('btn-secondary');
                listBtn.innerHTML = 'üìã Lihat Senarai Imam';
            }
        }
        
        function toggleBilalList() {
            const listSection = document.getElementById('bilalListSection');
            const listBtn = document.getElementById('toggleBilalListBtn');
            
            if (listSection.classList.contains('hidden')) {
                listSection.classList.remove('hidden');
                listBtn.classList.remove('btn-secondary');
                listBtn.classList.add('btn-primary');
                listBtn.innerHTML = '‚ùå Tutup Senarai';
            } else {
                listSection.classList.add('hidden');
                listBtn.classList.remove('btn-primary');
                listBtn.classList.add('btn-secondary');
                listBtn.innerHTML = 'üìã Lihat Senarai Bilal';
            }
        }
        
        function toggleSiakList() {
            const listSection = document.getElementById('siakListSection');
            const listBtn = document.getElementById('toggleSiakListBtn');
            
            if (listSection.classList.contains('hidden')) {
                listSection.classList.remove('hidden');
                listBtn.classList.remove('btn-secondary');
                listBtn.classList.add('btn-primary');
                listBtn.innerHTML = '‚ùå Tutup Senarai';
            } else {
                listSection.classList.add('hidden');
                listBtn.classList.remove('btn-primary');
                listBtn.classList.add('btn-secondary');
                listBtn.innerHTML = 'üìã Lihat Senarai Siak';
            }
        }
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'993e674d462f0c6d',t:'MTc2MTM2MDU5Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>